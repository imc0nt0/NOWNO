<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê´‘ì£¼ì€í–‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
@font-face {
    font-family: 'Paperozi-M';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408-3@1.0/Paperlogy-5Medium.woff2') format('woff2');
    font-weight: 500;
    font-display: swap;
}
@font-face {
    font-family: 'Paperozi-B';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408-3@1.0/Paperlogy-9Black.woff2') format('woff2');
    font-weight: 900;
    font-display: swap;
}

body { margin:0; font-family:'Paperozi-B'; user-select:none; background:#f5f8fc; overflow-x:hidden; }
button { cursor:pointer; }

/* ì‹œì‘ í™”ë©´ */
#startScreen{
    position:fixed;top:0;left:0;width:100%;height:100%;
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    background:linear-gradient(135deg,#e0f0ff,#f5f8fc);
    z-index:10000;overflow:hidden;
}
#startScreen button{padding:40px 80px;font-family:'Paperozi-B';font-size:40px;background:#0078ff;color:#fff;border:none;border-radius:16px;box-shadow:0 6px 15px rgba(0,0,0,0.3);transition:transform 0.2s,box-shadow 0.2s;}
#startScreen button:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,0.4);}

/* ATM UI */
#atmUI{display:none;}
.top-bar{width:100%;padding:25px 50px;display:flex;align-items:center;background:white;box-shadow:0 2px 6px rgba(0,0,0,0.07);}
.top-bar img{height:70px;}
.container{display:flex;padding:40px;gap:40px;}
.left-area{width:60%;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr) 120px;gap:20px;}
.tile{border-radius:18px;color:white;padding:25px;font-size:28px;font-weight:700;display:flex;flex-direction:column;justify-content:space-between;position:relative;}
.tile .icon-box{width:65px;height:65px;margin-bottom:10px;}
.tile img.icon{width:100%;height:100%;opacity:0.95;position:static;}
.tile .label{font-size:30px;margin-top:auto;}
.t1,.t2,.t3{background:#ccc;color:#333;}
.t4{background:#0078ff;color:#fff;}
.dark-tile{background:#ccc;color:#333;grid-column:span 2;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;}
.right-area{width:40%;display:grid;grid-template-columns:repeat(2,1fr);gap:20px;}
.small-btn{background:#ccc;color:#333;border-radius:14px;padding:22px;font-size:18px;font-weight:600;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.08);position:relative;}

/* ëª¨ë‹¬ */
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5);backdrop-filter:blur(3px);}
.modal-content{background:#fff;margin:10% auto;padding:30px 20px;border-radius:16px;width:450px;max-width:90%;box-shadow:0 8px 20px rgba(0,0,0,0.25);text-align:center;font-family:"Noto Sans KR",sans-serif;transform:translateY(-50px);opacity:0;animation:slideDown 0.4s ease forwards;}
.modal-content h2{margin-top:0;color:#0078ff;font-size:32px;font-weight:800;}
.modal-content p{color:#333;font-size:22px;margin:20px 0;line-height:1.4;}
.modal-content button{padding:10px 28px;border:none;border-radius:12px;background:#0078ff;color:#fff;font-size:38px;font-family:'Paperozi-B';font-weight:700;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;}
.modal-content button:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,0.2);}
.modal img{width:100%;border-radius:12px;margin-bottom:20px;}
@keyframes slideDown{from{transform:translateY(-50px);opacity:0;}to{transform:translateY(0);opacity:1;}}

/* ì ê¸ˆ ì™„ë£Œ */
#depositScreen{display:none;max-width:900px;margin:20px auto;padding:40px 50px;background:rgba(255,255,255,0.95);border-radius:25px;box-shadow:0 12px 35px rgba(0,0,0,0.2);text-align:center;position:relative;z-index:1;}
#depositScreen h1{font-size:48px;color:#ff4081;margin-bottom:15px;}
#depositScreen h2{color:#0078ff;font-size:28px;margin:25px 0 15px;}
#depositScreen p{font-size:22px;color:#333;margin:5px 0;}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:18px;margin-top:15px;border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
th,td{padding:12px;text-align:center;}
th{background:#0078ff;color:white;font-weight:600;}
tbody tr:nth-child(odd){background:#f8faff;}
tbody tr:nth-child(even){background:#fff0f5;}
tbody tr:hover{background:#ffe0f5;}

/* ì¸ì¶œ ë²„íŠ¼ */
#withdrawBtn{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);padding:16px 40px;font-family:'Paperozi-B';font-size:22px;border:none;border-radius:12px;background:#ff4081;color:white;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.3);transition:bottom 0.5s;z-index:999;}

/* í­ì£½/ì½˜í˜í‹° */
.firework{width:12px;height:12px;border-radius:50%;pointer-events:none;animation:explode 1s ease-out forwards;position:fixed;}
@keyframes explode{0%{transform:scale(1) translate(0,0);opacity:1;}100%{transform:scale(0.5) translate(var(--x),var(--y));opacity:0;}}
.confetti{width:10px;height:10px;border-radius:50%;pointer-events:none;animation:fall 3s infinite linear;position:fixed;}
@keyframes fall{0%{transform:translateY(-50px) rotate(0deg);}100%{transform:translateY(500px) rotate(360deg);}}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 768px) {
    body { font-size: 14px; }
    #startScreen button { padding: 25px 50px; font-size: 28px; }
    #startScreen img { width: 300px; }
    #startScreen p { font-size: 28px; }
    #adBanner { width: 90%; height: auto; }
    #adBanner img { width: 100%; height: auto; }
    .container { flex-direction: column; padding: 20px; }
    .left-area, .right-area { width: 100%; grid-template-columns: repeat(2, 1fr); }
    .tile { font-size: 20px; padding: 15px; }
    .tile .label { font-size: 20px; }
    .tile .icon-box { width: 50px; height: 50px; }
    .dark-tile { font-size: 20px; }
    .small-btn { padding: 15px; font-size: 16px; }
    .modal-content { width: 90%; padding: 20px 15px; font-size: 16px; }
    .modal-content h2 { font-size: 24px; }
    .modal-content p { font-size: 16px; }
    .modal-content button { font-size: 28px; padding: 8px 20px; }
    #depositScreen { padding: 20px; }
    #depositScreen h1 { font-size: 32px; }
    #depositScreen h2 { font-size: 22px; }
    #depositScreen p { font-size: 16px; }
    table { font-size: 14px; }
    th, td { padding: 8px; }
    #withdrawBtn { font-size: 18px; padding: 12px 25px; }
}
</style>
</head>
<body>
<!-- ì‹œì‘ í™”ë©´ -->
<div id="startScreen">
    <button id="fullscreenBtn">ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° & ì „ì²´í™”ë©´</button>
    <img src="logo.svg" alt="ê´‘ì£¼ì€í–‰ ë¡œê³ " style="width:400px;margin-bottom:20px;">
    <p style="font-size:40px;color:#0078ff;font-weight:700;margin-bottom:40px;">ê´‘ì£¼ì€í–‰ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
    <div id="adBanner" style="width:1400px;height:700px;position:relative;overflow:hidden;border-radius:16px;box-shadow:0 6px 15px rgba(0,0,0,0.2);margin-bottom:50px;">
        <img id="ad1" src="https://cdn.apnews.kr/news/photo/202405/3019634_42922_92.png" style="width:1400px;height:700px;position:absolute;top:0;left:0;opacity:1;transition:opacity 1s;">
        <img id="ad2" src="" style="width:1400px;height:700px;position:absolute;top:0;left:0;opacity:0;transition:opacity 1s;">
    </div>
    <button id="startBtn">ê±°ë˜ ì‹œì‘</button>
</div>

<!-- ATM UI -->
<div id="atmUI">
    <div class="top-bar"><img src="logo.svg" alt="logo"></div>
    <div class="container">
        <div class="left-area">
            <div class="tile t1"><div class="icon-box"><img class="icon" src="deposit-cash.svg"></div><div class="label">ì…ê¸ˆ</div></div>
            <div class="tile t2"><div class="icon-box"><img class="icon" src="icon_withdraw.png"></div><div class="label">ì¶œê¸ˆ</div></div>
            <div class="tile t3"><div class="icon-box"><img class="icon" src="icon_transfer.png"></div><div class="label">ê³„ì¢Œì´ì²´</div></div>
            <div class="tile t4"><div class="icon-box"><img class="icon" src="Passbook.png"></div><div class="label">ì¡°íšŒì—…ë¬´</div></div>
            <div class="dark-tile">ì™¸êµ­ì¸/ì¥ì• ì¸ ì „ìš© í™”ë©´</div>
        </div>
        <div class="right-area">
            <div class="small-btn">í†µì¥ ì •ë¦¬</div>
            <div class="small-btn">ë¶„ì‹¤ ì‹ ê³ </div>
            <div class="small-btn">ê³µê³¼ê¸ˆ ë‚©ë¶€</div>
            <div class="small-btn">ì§€ë°©ì„¸/êµ­ì„¸</div>
            <div class="small-btn">ì˜ˆíƒ/ë“±ë¡ê¸ˆ</div>
            <div class="small-btn">ê³ ê°ì„¼í„°</div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2>ì´ìš© ì œí•œ ì•ˆë‚´</h2>
        <p>ì´ìš©í•  ìˆ˜ ì—†ëŠ” ì—…ë¬´ì…ë‹ˆë‹¤.</p>
        <button id="closeModal">í™•ì¸</button>
    </div>
</div>
<div id="imageModal" class="modal">
    <div class="modal-content">
        <img src="https://thumb.mt.co.kr/cdn-cgi/image/f=auto/06/2022/08/2022082510131458767_1.jpg" alt="ì¡°íšŒ ì´ë¯¸ì§€">
        <button id="redirectBtn">í™•ì¸</button>
    </div>
</div>

<!-- ì ê¸ˆ ì™„ë£Œ í™”ë©´ -->
<div id="depositScreen">
    <img src="logo.svg" alt="ê´‘ì£¼ì€í–‰ ë¡œê³ " style="width:400px;margin-bottom:20px;">
    <h1>ì ê¸ˆ ì™„ë£Œ</h1>
    <p>â€œí–‰ë³µ ë“œë¦¼ ì ê¸ˆâ€ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
    <h2>í†µì¥ ì •ë³´</h2>
    <p>ê³„ì¢Œë²ˆí˜¸: 123-456-7890</p>
    <p>ì ê¸ˆ ì´ë¦„: í–‰ë³µ ë“œë¦¼ ì ê¸ˆ</p>
    <p>ì´ ê¸ˆì•¡: 1,000,000ì›</p>
    <h2>ì…ê¸ˆ ë‚´ì—­</h2>
    <table>
        <thead><tr><th>ë‚ ì§œ</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th></tr></thead>
        <tbody>
            <tr><td>2025-11-01</td><td>100,000ì›</td><td>ì²« ì…ê¸ˆ ğŸ‰</td></tr>
            <tr><td>2025-11-08</td><td>50,000ì›</td><td>ìƒì¼ ì„ ë¬¼ ğŸ’</td></tr>
            <tr><td>2025-11-15</td><td>50,000ì›</td><td>ì¶”ê°€ ì…ê¸ˆ âœ¨</td></tr>
            <tr><td>2025-11-22</td><td>1,000,000ì›</td><td>ì ê¸ˆ ì™„ë£Œ ğŸ†</td></tr>
            <!-- ë°˜ë³µ ë°ì´í„°ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤ -->
        </tbody>
    </table>
</div>

<audio id="MainSound" src="Main.mp3"></audio>
<audio id="SELECTSOUND" src="SELECT.mp3"></audio>

<button id="withdrawBtn">ì¸ì¶œí•˜ê¸°</button>
<div id="withdrawStatus"></div>

<!-- ì¹´ë“œ/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
<style>
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5);backdrop-filter:blur(3px);}
.modal-content{background:#fff;margin:10% auto;padding:30px 20px;border-radius:16px;width:450px;max-width:90%;box-shadow:0 8px 20px rgba(0,0,0,0.25);text-align:center;font-family:"Noto Sans KR",sans-serif;transform:translateY(-50px);opacity:0;animation:slideDown 0.4s ease forwards;}
.modal-content h2{margin-top:0;color:#0078ff;font-size:32px;font-weight:800;}
.modal-content p{color:#333;font-size:22px;margin:20px 0;line-height:1.4;}
.modal-content input{padding:12px 8px;font-size:22px;width:60%;margin:10px auto;display:block;text-align:center;}
.modal-content button{padding:10px 28px;border:none;border-radius:12px;background:#0078ff;color:#fff;font-size:38px;font-weight:700;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;}
.modal-content button:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,0.2);}
</style>

<div id="cardModal" class="modal">
  <div class="modal-content">
    <h2>ì¹´ë“œ ì¸ì‹</h2>
    <p>ì¹´ë“œë¥¼ ì‚½ì…í•´ì£¼ì„¸ìš”</p>
  </div>
</div>

<div id="pinModal" class="modal">
  <div class="modal-content">
    <h2>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h2>
    <input type="password" id="pinInput" maxlength="4" placeholder="****">
    <button id="pinSubmitBtn">í™•ì¸</button>
  </div>
</div>

<script>
/*
  Web Bluetooth (BLE NUS) implementation
  - ESP32 / BLE device should advertise NUS service:
    SERVICE: 6e400001-b5a3-f393-e0a9-e50e24dcca9e
    RX char (write): 6e400002-b5a3-f393-e0a9-e50e24dcca9e (browser -> device)
    TX char (notify):6e400003-b5a3-f393-e0a9-e50e24dcca9e (device -> browser)
  - ë¸Œë¼ìš°ì €ëŠ” HTTPS ë˜ëŠ” localhostì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤.
*/

// NUS UUIDs
const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_CHAR_RX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write (browser -> device)
const NUS_CHAR_TX_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify (device -> browser)

// BLE state
let bleDevice = null;
let gattServer = null;
let nusService = null;
let txChar = null; // notify
let rxChar = null; // write

// Notification buffering and one-shot readers
let notificationBuffer = ''; // ëˆ„ì  í…ìŠ¤íŠ¸
let pendingResolvers = [];    // readOnceì—ì„œ ëŒ€ê¸°ì¤‘ì¸ ë¦¬ì¡¸ë²„ë“¤

// UI refs
const fullscreenBtn = document.getElementById('fullscreenBtn');
const startBtn = document.getElementById('startBtn');
const ad1 = document.getElementById('ad1');
const ad2 = document.getElementById('ad2');
const ads = [
    "https://cdn.apnews.kr/news/photo/202405/3019634_42922_92.png",
    "https://thumbnews.nateimg.co.kr/view610///news.nateimg.co.kr/orgImg/wh/2025/11/14/1296320_1488750_4248.jpg",
    "https://img.tf.co.kr/article/home/2023/11/14/20235860169994256200.jpg"
];
const cardModal = document.getElementById('cardModal');
const pinModal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const pinSubmitBtn = document.getElementById('pinSubmitBtn');
const withdrawBtn = document.getElementById('withdrawBtn');
const atmUI = document.getElementById('atmUI');
const selectSound = document.getElementById('SELECTSOUND');
const mainAudio = document.getElementById('MainSound');
let current = 0, next = 1;
let isWithdrawFlow = false; // ì¸ì¶œ íë¦„ì¸ì§€ í”Œë˜ê·¸

// ê´‘ê³  ìŠ¬ë¼ì´ë“œ
function nextSlide(){
    ad2.src = ads[next];
    ad1.style.opacity=0; 
    ad2.style.opacity=1;
    setTimeout(()=>{
        ad1.src=ads[next];
        ad1.style.opacity=1;
        ad2.style.opacity=0;
        current=next;
        next=(next+1)%ads.length;
    }, 1000);
}
setInterval(nextSlide,4000);

// ì „ì²´í™”ë©´ + BLE ì—°ê²° ë²„íŠ¼ (ì‚¬ìš©ìê°€ ëˆ„ë¥¼ ë•Œ BLE ì¥ì¹˜ ì„ íƒ íŒì—…ì´ ëœ¸)
fullscreenBtn.addEventListener('click', async () => {
    fullscreenBtn.style.display = 'none';
    try {
        await connectBLE(); // ì—°ê²° ì‹œë„
        alert('BLE ì—°ê²° ì„±ê³µ!');
    } catch (e) {
        console.error('BLE ì—°ê²° ì‹¤íŒ¨:', e);
        alert('BLE ì—°ê²° ì‹¤íŒ¨: ' + (e && e.message ? e.message : e));
        // ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ
        fullscreenBtn.style.display = '';
    }

    // ì „ì²´í™”ë©´ ì§„ì… (ê°€ëŠ¥í•˜ë©´)
    const elem = document.documentElement;
    if (elem.requestFullscreen) {
        try { await elem.requestFullscreen(); } catch {}
    } else if (elem.webkitRequestFullscreen) {
        try { await elem.webkitRequestFullscreen(); } catch {}
    } else if (elem.msRequestFullscreen) {
        try { await elem.msRequestFullscreen(); } catch {}
    }
});

// start ë²„íŠ¼
startBtn.addEventListener('click', ()=>{
    mainAudio.volume=1.0; 
    mainAudio.play().catch(()=>{});
    document.getElementById("startScreen").style.display='none';
    document.getElementById("atmUI").style.display='block';
});

// BLE ì—°ê²° í•¨ìˆ˜
async function connectBLE() {
    if (!('bluetooth' in navigator)) throw new Error('Web Bluetooth ì§€ì› ì•ˆë¨');
    if (bleDevice && bleDevice.gatt && bleDevice.gatt.connected) return;

    // ì„œë¹„ìŠ¤ í•„í„°ë¡œ ì¥ì¹˜ ì„ íƒì°½ í‘œì‹œ
    const options = {
        filters: [{ services: [NUS_SERVICE_UUID] }],
        optionalServices: [NUS_SERVICE_UUID]
    };

    bleDevice = await navigator.bluetooth.requestDevice(options);
    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
    gattServer = await bleDevice.gatt.connect();
    nusService = await gattServer.getPrimaryService(NUS_SERVICE_UUID);
    txChar = await nusService.getCharacteristic(NUS_CHAR_TX_UUID);
    rxChar = await nusService.getCharacteristic(NUS_CHAR_RX_UUID);

    // notify ì‹œì‘
    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', handleNotifications);
}

// disconnect handler
function onDisconnected() {
    console.warn('BLE ì¥ì¹˜ ì—°ê²° ëŠê¹€');
    showWithdrawStatus('BLE ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', true);
    // ìë™ ì¬ì—°ê²° ì •ì±…ì€ í•„ìš”í•˜ë©´ ì¶”ê°€
}

// notification ì²˜ë¦¬: í…ìŠ¤íŠ¸ ëˆ„ì , ì¤„ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ì—¬ pending resolverë¡œ ì „ë‹¬
function handleNotifications(event) {
    const value = event.target.value;
    const decoder = new TextDecoder();
    const txt = decoder.decode(value);
    notificationBuffer += txt;

    // newline ê¸°ì¤€ìœ¼ë¡œ ë©”ì‹œì§€ ë¶„ë¦¬
    const parts = notificationBuffer.split(/\r?\n/);
    // ë§ˆì§€ë§‰ì€ ë¶ˆì™„ì „í•  ìˆ˜ ìˆì–´ ë²„í¼ë¡œ ë‚¨ê¹€
    notificationBuffer = parts.pop() || '';

    parts.forEach(part => {
        if (!part) return;
        // ëª¨ë“  pending resolverì—ê²Œ ì „ë‹¬ (readOnce ë‹¨ì¼ ëŒ€ê¸°ì ì„¤ê³„)
        while (pendingResolvers.length > 0) {
            const resolver = pendingResolvers.shift();
            try { resolver(part); } catch(e){ console.error(e); }
        }
        // ì¶”ê°€ë¡œ ì¦‰ì‹œ ì²˜ë¦¬í•  íŠ¹ì • ë©”ì‹œì§€ëŠ” ì—¬ê¸°ì„œë„ ì²˜ë¦¬ ê°€ëŠ¥
        // ex) if (part.includes('CARD_DETECTED')) { ... }
    });
}

// write to device (browser -> device)
async function writeToDevice(str) {
    if (!rxChar) throw new Error('RX characteristic ì—†ìŒ');
    const encoder = new TextEncoder();
    await rxChar.writeValue(encoder.encode(str));
}

// readOnce: timeout ë‚´ì— íŠ¹ì • ì•Œë¦¼(CARD_DETECTED)ì„ ê¸°ë‹¤ë¦¼
function readOnce(timeoutMs = 5000) {
    return new Promise((resolve) => {
        // ë¨¼ì € ë²„í¼ì— ì´ë¯¸ ìˆëŠ”ì§€ ê²€ì‚¬
        if (notificationBuffer.includes('CARD_DETECTED')) {
            // consume
            notificationBuffer = notificationBuffer.replace('CARD_DETECTED','');
            resolve(true);
            return;
        }
        let timed = false;
        const timer = setTimeout(() => {
            timed = true;
            // remove resolver if still present
            pendingResolvers = pendingResolvers.filter(r => r !== resolver);
            resolve(false);
        }, timeoutMs);

        const resolver = (msg) => {
            if (timed) return;
            clearTimeout(timer);
            if (msg.includes('CARD_DETECTED')) {
                resolve(true);
            } else {
                resolve(false);
            }
        };
        pendingResolvers.push(resolver);
    });
}

/*
 startCardDetection:
  - repeatCount íšŒ ì—°ì†(ë˜ëŠ” ìˆœì°¨)ìœ¼ë¡œ readOnceë¥¼ ì‹¤í–‰í•´ ëª¨ë‘ ì„±ê³µí•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰.
*/
async function startCardDetection(repeatCount = 2, timeoutPerAttempt = 5000) {
    try {
        if (!bleDevice || !bleDevice.gatt.connected) {
            await connectBLE();
        }
    } catch (e) {
        console.error('BLE ì—´ê¸° ì‹¤íŒ¨', e);
        showWithdrawStatus('BLE ì—°ê²° ì‹¤íŒ¨', true, 2000);
        return false;
    }

    for (let i = 1; i <= repeatCount; i++) {
        showWithdrawStatus(`ì¹´ë“œ ê°ì§€ ì‹œì‘ ${i}íšŒì°¨`, false);
        console.log(`ì¹´ë“œ ê°ì§€ ì‹œì‘ ${i}íšŒì°¨`);
        const detected = await readOnce(timeoutPerAttempt);
        if (detected) {
            console.log(`ì¹´ë“œ ê°ì§€ ${i}íšŒì°¨ ì„±ê³µ`);
            showWithdrawStatus(`ì¹´ë“œ ì¸ì‹ ${i}íšŒì°¨ ì™„ë£Œ`, false);
            if (i < repeatCount) {
                await new Promise(r => setTimeout(r, 200));
                continue;
            }
            // ëª¨ë“  íšŒì°¨ ì„±ê³µ -> PIN ëª¨ë‹¬ë¡œ ì´ë™
            if (cardModal) cardModal.style.display = 'none';
            if (pinModal) pinModal.style.display = 'block';
            return true;
        } else {
            console.warn(`ì¹´ë“œ ê°ì§€ ${i}íšŒì°¨ ì‹¤íŒ¨`);
            showWithdrawStatus(`ì¹´ë“œ ì¸ì‹ ${i}íšŒì°¨ ì‹¤íŒ¨`, true, 2000);
            return false;
        }
    }
    return false;
}

// imageModalì˜ í™•ì¸ ë²„íŠ¼: ì¡°íšŒ íë¦„ì—ì„œ ì¹´ë“œ ê°ì§€ ì¦‰ì‹œ ì‹œì‘
document.getElementById('redirectBtn').addEventListener('click', async () => {
    document.getElementById('imageModal').style.display = 'none';
    cardModal.style.display = 'block';
    showWithdrawStatus('ì¹´ë“œë¥¼ ì„¼ì„œì— ëŒ€ì„¸ìš”');
    try {
        await startCardDetection(2);
    } catch (e) {
        console.error(e);
        showWithdrawStatus('ì¹´ë“œ ê°ì§€ ì‹¤íŒ¨', true);
    }
});

// ì¶œê¸ˆ ë²„íŠ¼
withdrawBtn.addEventListener('click', () => {
    isWithdrawFlow = true;
    cardModal.style.display = 'block';
    // ìë™ìœ¼ë¡œ MutationObserver ë˜ëŠ” ì§ì ‘ í˜¸ì¶œë¡œ ê°ì§€ ì‹œì‘
    startCardDetection();
});

// ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('closeModal').addEventListener('click', ()=> {
    document.getElementById('modal').style.display='none';
    selectSound.play().catch(()=>{});
});

// PIN ì œì¶œ ì²˜ë¦¬
pinSubmitBtn.addEventListener('click', async () => {
    const pin = (pinInput.value || '').trim();
    if (pin !== '1234') {
        showWithdrawStatus("PIN ì˜¤ë¥˜", true);
        pinInput.value = '';
        return;
    }
    pinInput.value = '';
    pinModal.style.display = 'none';

    // ì¸ì¦ ì„±ê³µ â†’ í™”ë©´ ì „í™˜
    atmUI.style.display = 'none';
    document.getElementById('depositScreen').style.display = 'block';
    createFireworks();
    createConfetti();

    // ì¸ì¶œ íë¦„ì´ë©´ BLEë¡œ '1' ì „ì†¡
    if (isWithdrawFlow) {
        try {
            if (!rxChar) {
                showWithdrawStatus("BLE ì—°ê²° ëŠê¹€", true);
                return;
            }
            await writeToDevice('1'); // ESP32ê°€ ì´ë¥¼ ë°›ì•„ LED ë“± ë™ì‘
            showWithdrawStatus("ì¸ì¶œ ì™„ë£Œ");
        } catch (e) {
            console.error("ì¸ì¶œ ì‹ í˜¸ ì „ì†¡ ì‹¤íŒ¨:", e);
            showWithdrawStatus("ì¸ì¶œ ì‹ í˜¸ ì‹¤íŒ¨", true);
        }
    }

    isWithdrawFlow = false;
});

// ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ê°ì§€ ìë™ ì‹œì‘ (ì„ íƒì )
const observer = new MutationObserver(() => {
    const display = window.getComputedStyle(cardModal).display;
    if (display !== 'none') {
        // ëª¨ë‹¬ì´ ë³´ì´ë©´ ê°ì§€ ì‹œì‘
        startCardDetection();
    }
});
observer.observe(cardModal, { attributes: true });

// ìƒíƒœ í‘œì‹œ
function showWithdrawStatus(msg, isError=false, duration=2000){
    const statusDiv = document.getElementById("withdrawStatus");
    statusDiv.textContent = msg;
    statusDiv.style.background = isError ? "rgba(255,64,129,0.95)" : "rgba(0,120,255,0.95)";
    statusDiv.style.color = "#fff";
    statusDiv.style.padding = "10px 16px";
    statusDiv.style.borderRadius = "8px";
    statusDiv.style.position = "fixed";
    statusDiv.style.left = "50%";
    statusDiv.style.transform = "translateX(-50%)";
    statusDiv.style.bottom = "90px";
    statusDiv.style.display="block";
    setTimeout(()=>{ statusDiv.style.display="none"; }, duration);
}

// í­ì£½/ì½˜í˜í‹°
function createFireworks(){
    for(let i=0;i<200;i++){
        const dot=document.createElement('div');
        dot.className='firework';
        dot.style.left=(window.innerWidth/2+(Math.random()-0.5)*200)+'px';
        dot.style.top=(window.innerHeight/2+(Math.random()-0.5)*200)+'px';
        const angle=Math.random()*2*Math.PI;
        const dist=600+Math.random()*100;
        dot.style.setProperty('--x',`${Math.cos(angle)*dist}px`);
        dot.style.setProperty('--y',`${Math.sin(angle)*dist}px`);
        dot.style.background=`hsl(${Math.random()*360},80%,60%)`;
        document.body.appendChild(dot);
        setTimeout(()=>dot.remove(),1000);
    }
}
function createConfetti(){
    for(let i=0;i<400;i++){
        const c=document.createElement('div');
        c.className='confetti';
        c.style.left=Math.random()*window.innerWidth+'px';
        c.style.top=Math.random()*window.innerHeight+'px';
        c.style.width=c.style.height=(5+Math.random()*10)+'px';
        c.style.background=`hsl(${Math.random()*360},70%,60%)`;
        c.style.animationDuration=(2+Math.random()*3)+'s';
        document.body.appendChild(c);
        // confetti ì •ë¦¬: ì˜¤ë˜ëœ ê²ƒ ìë™ ì œê±°(ì„ íƒ)
        setTimeout(()=>c.remove(), 7000);
    }
}

// ìŠ¤í¬ë¡¤ì— ë”°ë¼ withdrawBtn ìœ„ì¹˜ ë³´ì •
window.addEventListener('scroll', ()=>{
    const scrollTop = window.scrollY,
          scrollHeight = document.body.scrollHeight - window.innerHeight;
    withdrawBtn.style.bottom = (scrollTop >= scrollHeight - 50) ? '20px' : '-80px';
});

</script>
</body>
</html>
