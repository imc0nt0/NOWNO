<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê´‘ì£¼ì€í–‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
@font-face {
    font-family: 'Paperozi-M';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408-3@1.0/Paperlogy-5Medium.woff2') format('woff2');
    font-weight: 500;
    font-display: swap;
}
@font-face {
    font-family: 'Paperozi-B';
    src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2408-3@1.0/Paperlogy-9Black.woff2') format('woff2');
    font-weight: 900;
    font-display: swap;
}
body { margin:0; font-family:'Paperozi-B'; user-select:none; background:#f5f8fc; overflow-x:hidden; }
button { cursor:pointer; }

/* ì‹œì‘ í™”ë©´ */
#startScreen{
    position:fixed;top:0;left:0;width:100%;height:100%;
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    background:linear-gradient(135deg,#e0f0ff,#f5f8fc);
    z-index:10000;overflow:hidden;
}
#startScreen button{padding:40px 80px;font-family:'Paperozi-B';font-size:40px;background:#0078ff;color:#fff;border:none;border-radius:16px;box-shadow:0 6px 15px rgba(0,0,0,0.3);transition:transform 0.2s,box-shadow 0.2s;}
#startScreen button:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,0.4);}

/* ATM UI */
#atmUI{display:none;}
.top-bar{width:100%;padding:25px 50px;display:flex;align-items:center;background:white;box-shadow:0 2px 6px rgba(0,0,0,0.07);}
.top-bar img{height:70px;}
.container{display:flex;padding:40px;gap:40px;}
.left-area{width:60%;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr) 120px;gap:20px;}
.tile{border-radius:18px;color:white;padding:25px;font-size:28px;font-weight:700;display:flex;flex-direction:column;justify-content:space-between;position:relative;}
.tile .icon-box{width:65px;height:65px;margin-bottom:10px;}
.tile img.icon{width:100%;height:100%;opacity:0.95;position:static;}
.tile .label{font-size:30px;margin-top:auto;}
.t1,.t2,.t3{background:#ccc;color:#333;}
.t4{background:#0078ff;color:#fff; cursor:pointer;}
.dark-tile{background:#ccc;color:#333;grid-column:span 2;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;}
.right-area{width:40%;display:grid;grid-template-columns:repeat(2,1fr);gap:20px;}
.small-btn{background:#ccc;color:#333;border-radius:14px;padding:22px;font-size:18px;font-weight:600;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.08);position:relative;}

/* modal ê¸°ë³¸ */
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5);backdrop-filter:blur(3px);}
.modal-content{background:#fff;margin:10% auto;padding:30px 20px;border-radius:16px;width:450px;max-width:90%;box-shadow:0 8px 20px rgba(0,0,0,0.25);text-align:center;font-family:"Noto Sans KR",sans-serif;transform:translateY(-50px);opacity:0;animation:slideDown 0.4s ease forwards;}
.modal-content h2{margin-top:0;color:#0078ff;font-size:32px;font-weight:800;}
.modal-content p{color:#333;font-size:22px;margin:20px 0;line-height:1.4;}
.modal-content button{padding:10px 28px;border:none;border-radius:12px;background:#0078ff;color:#fff;font-size:38px;font-family:'Paperozi-B';font-weight:700;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;}
.modal-content button:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(0,0,0,0.2);}
.modal img{width:100%;border-radius:12px;margin-bottom:20px;}
@keyframes slideDown{from{transform:translateY(-50px);opacity:0;}to{transform:translateY(0);opacity:1;}}

/* ì ê¸ˆ ì™„ë£Œ */
#depositScreen{display:none;max-width:900px;margin:20px auto;padding:40px 50px;background:rgba(255,255,255,0.95);border-radius:25px;box-shadow:0 12px 35px rgba(0,0,0,0.2);text-align:center;position:relative;z-index:1;}
#depositScreen h1{font-size:48px;color:#ff4081;margin-bottom:15px;}
#depositScreen h2{color:#0078ff;font-size:28px;margin:25px 0 15px;}
#depositScreen p{font-size:22px;color:#333;margin:5px 0;}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:18px;margin-top:15px;border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
th,td{padding:12px;text-align:center;}
th{background:#0078ff;color:white;font-weight:600;}
tbody tr:nth-child(odd){background:#f8faff;}
tbody tr:nth-child(even){background:#fff0f5;}
tbody tr:hover{background:#ffe0f5;}

/* ì¹´ë“œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.card-modal{ display:none; align-items:center; justify-content:center; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; }
.card-box{ background:#fff; padding:32px; border-radius:18px; width:360px; text-align:center; box-shadow:0 12px 30px rgba(0,0,0,0.25); }
.card-box h2{ color:#0078ff; margin:0 0 8px; font-size:26px; }
.card-box p{ color:#666; margin:0 0 18px; }
.card-scan-animation{ margin:0 auto 18px; width:260px; height:80px; border-radius:10px; background:linear-gradient(90deg,#e9f3ff,#fff); position:relative; overflow:hidden; }
.card-scan-animation::before{ content:""; position:absolute; left:-60px; top:0; width:60px; height:100%; background:rgba(0,120,255,0.12); animation:scan 1s linear infinite; }
@keyframes scan{ 0%{ left:-60px } 100%{ left:320px } }
.small-action{ margin-top:8px; padding:10px 18px; border-radius:10px; border:none; background:#eee; cursor:pointer; }
.small-action:hover{ transform:translateY(-2px); }

/* PIN ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.pin-modal{ display:none; align-items:center; justify-content:center; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; }
.pin-box{ background:#fff; padding:24px; border-radius:18px; width:360px; text-align:center; box-shadow:0 12px 30px rgba(0,0,0,0.25); }
.pin-display{ width:80%; font-size:28px; text-align:center; padding:10px; margin-bottom:16px; border-radius:10px; border:2px solid #eee; }
.keypad{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
.key{ padding:14px 0; font-size:20px; border-radius:10px; border:none; background:#f1f1f1; cursor:pointer; }
.key.enter{ background:#0078ff; color:#fff; grid-column:span 1; }
.key.clear{ background:#ff6b6b; color:#fff; }
.key:active{ transform:scale(0.98); }

/* ì¸ì¶œ ë²„íŠ¼ */
#withdrawBtn{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);padding:16px 40px;font-family:'Paperozi-B';font-size:22px;border:none;border-radius:12px;background:#ff4081;color:white;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.3);transition:bottom 0.5s;z-index:999;}

/* ìƒíƒœ í…ìŠ¤íŠ¸ */
#withdrawStatus{ display:none; position:fixed; left:50%; transform:translateX(-50%); bottom:90px; padding:10px 16px; border-radius:8px; color:#fff; z-index:10001; }

/* í­ì£½/ì½˜í˜í‹° */
.firework{width:12px;height:12px;border-radius:50%;pointer-events:none;animation:explode 1s ease-out forwards;position:fixed;}
@keyframes explode{0%{transform:scale(1) translate(0,0);opacity:1;}100%{transform:scale(0.5) translate(var(--x),var(--y));opacity:0;}}
.confetti{width:10px;height:10px;border-radius:50%;pointer-events:none;animation:fall 3s infinite linear;position:fixed;}
@keyframes fall{0%{transform:translateY(-50px) rotate(0deg);}100%{transform:translateY(500px) rotate(360deg);}}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 768px) {
    body { font-size: 14px; }
    #startScreen button { padding: 25px 50px; font-size: 28px; }
    #startScreen img { width: 300px; }
    #startScreen p { font-size: 28px; }
    #adBanner { width: 90%; height: auto; }
    #adBanner img { width: 100%; height: auto; }
    .container { flex-direction: column; padding: 20px; }
    .left-area, .right-area { width: 100%; grid-template-columns: repeat(2, 1fr); }
    .tile { font-size: 20px; padding: 15px; }
    .tile .label { font-size: 20px; }
    .tile .icon-box { width: 50px; height: 50px; }
    .dark-tile { font-size: 20px; }
    .small-btn { padding: 15px; font-size: 16px; }
    .modal-content { width: 90%; padding: 20px 15px; font-size: 16px; }
    .modal-content h2 { font-size: 24px; }
    .modal-content p { font-size: 16px; }
    .modal-content button { font-size: 28px; padding: 8px 20px; }
    #depositScreen { padding: 20px; }
    #depositScreen h1 { font-size: 32px; }
    #depositScreen h2 { font-size: 22px; }
    #depositScreen p { font-size: 16px; }
    table { font-size: 14px; }
    th, td { padding: 8px; }
    #withdrawBtn { font-size: 18px; padding: 12px 25px; }
}
</style>
</head>
<body>
<!-- ì‹œì‘ í™”ë©´ -->
<div id="startScreen">
    <button id="fullscreenBtn">ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° & ì „ì²´í™”ë©´</button>
    <img src="logo.svg" alt="ê´‘ì£¼ì€í–‰ ë¡œê³ " style="width:400px;margin-bottom:20px;">
    <p style="font-size:40px;color:#0078ff;font-weight:700;margin-bottom:40px;">ê´‘ì£¼ì€í–‰ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
    <div id="adBanner" style="width:1400px;height:700px;position:relative;overflow:hidden;border-radius:16px;box-shadow:0 6px 15px rgba(0,0,0,0.2);margin-bottom:50px;">
        <img id="ad1" src="https://cdn.apnews.kr/news/photo/202405/3019634_42922_92.png" style="width:1400px;height:700px;position:absolute;top:0;left:0;opacity:1;transition:opacity 1s;">
        <img id="ad2" src="" style="width:1400px;height:700px;position:absolute;top:0;left:0;opacity:0;transition:opacity 1s;">
    </div>
    <button id="startBtn">ê±°ë˜ ì‹œì‘</button>
</div>

<!-- ATM UI -->
<div id="atmUI">
    <div class="top-bar"><img src="logo.svg" alt="logo"></div>
    <div class="container">
        <div class="left-area">
            <div class="tile t1"><div class="icon-box"><img class="icon" src="deposit-cash.svg"></div><div class="label">ì…ê¸ˆ</div></div>
            <div class="tile t2"><div class="icon-box"><img class="icon" src="icon_withdraw.png"></div><div class="label">ì¶œê¸ˆ</div></div>
            <div class="tile t3"><div class="icon-box"><img class="icon" src="icon_transfer.png"></div><div class="label">ê³„ì¢Œì´ì²´</div></div>
            <div class="tile t4"><div class="icon-box"><img class="icon" src="Passbook.png"></div><div class="label">ì¡°íšŒì—…ë¬´</div></div>
            <div class="dark-tile">ì™¸êµ­ì¸/ì¥ì• ì¸ ì „ìš© í™”ë©´</div>
        </div>
        <div class="right-area">
            <div class="small-btn">í†µì¥ ì •ë¦¬</div>
            <div class="small-btn">ë¶„ì‹¤ ì‹ ê³ </div>
            <div class="small-btn">ê³µê³¼ê¸ˆ ë‚©ë¶€</div>
            <div class="small-btn">ì§€ë°©ì„¸/êµ­ì„¸</div>
            <div class="small-btn">ì˜ˆíƒ/ë“±ë¡ê¸ˆ</div>
            <div class="small-btn">ê³ ê°ì„¼í„°</div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ ì¼ë°˜ -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2>ì´ìš© ì œí•œ ì•ˆë‚´</h2>
        <p>ì´ìš©í•  ìˆ˜ ì—†ëŠ” ì—…ë¬´ì…ë‹ˆë‹¤.</p>
        <button id="closeModal">í™•ì¸</button>
    </div>
</div>
<div id="imageModal" class="modal">
    <div class="modal-content">
        <img src="https://thumb.mt.co.kr/cdn-cgi/image/f=auto/06/2022/08/2022082510131458767_1.jpg" alt="ì¡°íšŒ ì´ë¯¸ì§€">
        <button id="redirectBtn">í™•ì¸</button>
    </div>
</div>

<!-- ì ê¸ˆ ì™„ë£Œ í™”ë©´ -->
<div id="depositScreen">
    <img src="logo.svg" alt="ê´‘ì£¼ì€í–‰ ë¡œê³ " style="width:400px;margin-bottom:20px;">
    <h1>ì ê¸ˆ ì™„ë£Œ</h1>
    <p>â€œí–‰ë³µ ë“œë¦¼ ì ê¸ˆâ€ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
    <h2>í†µì¥ ì •ë³´</h2>
    <p>ê³„ì¢Œë²ˆí˜¸: 123-456-7890</p>
    <p>ì ê¸ˆ ì´ë¦„: í–‰ë³µ ë“œë¦¼ ì ê¸ˆ</p>
    <p>ì´ ê¸ˆì•¡: 1,000,000ì›</p>
    <h2>ì…ê¸ˆ ë‚´ì—­</h2>
    <table>
        <thead><tr><th>ë‚ ì§œ</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th></tr></thead>
        <tbody>
            <tr><td>2025-11-01</td><td>100,000ì›</td><td>ì²« ì…ê¸ˆ ğŸ‰</td></tr>
            <tr><td>2025-11-08</td><td>50,000ì›</td><td>ìƒì¼ ì„ ë¬¼ ğŸ’</td></tr>
            <tr><td>2025-11-15</td><td>50,000ì›</td><td>ì¶”ê°€ ì…ê¸ˆ âœ¨</td></tr>
            <tr><td>2025-11-22</td><td>1,000,000ì›</td><td>ì ê¸ˆ ì™„ë£Œ ğŸ†</td></tr>
        </tbody>
    </table>
</div>

<audio id="MainSound" src="Main.mp3"></audio>
<audio id="SELECTSOUND" src="SELECT.mp3"></audio>

<button id="withdrawBtn">ì¸ì¶œí•˜ê¸°</button>
<div id="withdrawStatus"></div>

<!-- ì¹´ë“œ ëª¨ë‹¬ (êµì²´ëœ UI) -->
<div id="cardModal" class="card-modal">
  <div class="card-box">
    <h2>ì¹´ë“œë¥¼ ì„¼ì„œì— ëŒ€ì„¸ìš”</h2>
    <p id="cardModalHint">ì¹´ë“œë¥¼ ì„¼ì„œì— ê°€ê¹Œì´ ëŒ€ë©´ ìë™ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤.</p>
    <div class="card-scan-animation" aria-hidden="true"></div>
    <button id="cancelCardBtn" class="small-action">ì·¨ì†Œ</button>
  </div>
</div>

<!-- PIN ëª¨ë‹¬ (ìˆ«ì í‚¤íŒ¨ë“œ) -->
<div id="pinModal" class="pin-modal">
  <div class="pin-box">
    <h2>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h2>
    <input id="pinInput" class="pin-display" type="password" maxlength="4" readonly placeholder="----" />
    <div class="keypad" id="keypad">
      <button class="key">1</button><button class="key">2</button><button class="key">3</button>
      <button class="key">4</button><button class="key">5</button><button class="key">6</button>
      <button class="key">7</button><button class="key">8</button><button class="key">9</button>
      <button class="key clear">ì§€ì›€</button><button class="key">0</button>
      <button id="pinSubmitBtn" class="key enter">í™•ì¸</button>
    </div>
    <button id="pinCancelBtn" class="small-action" style="margin-top:12px;">ì·¨ì†Œ</button>
  </div>
</div>

<script>
/* =========================
   Web Bluetooth + UI í†µí•© ì „ì²´ ìŠ¤í¬ë¦½íŠ¸
   NUS UUIDs (ESP32 ìª½ê³¼ ì¼ì¹˜í•´ì•¼ í•¨)
   ========================= */
const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_CHAR_RX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_CHAR_TX_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

/* BLE state */
let bleDevice = null, gattServer = null, nusService = null, rxChar = null, txChar = null;

/* notification buffer & resolvers */
let notificationBuffer = '';
let pendingResolvers = [];

/* UI refs */
const fullscreenBtn = document.getElementById('fullscreenBtn');
const startBtn = document.getElementById('startBtn');
const ad1 = document.getElementById('ad1');
const ad2 = document.getElementById('ad2');
const ads = [
    "https://cdn.apnews.kr/news/photo/202405/3019634_42922_92.png",
    "https://thumbnews.nateimg.co.kr/view610///news.nateimg.co.kr/orgImg/wh/2025/11/14/1296320_1488750_4248.jpg",
    "https://img.tf.co.kr/article/home/2023/11/14/20235860169994256200.jpg"
];
const cardModal = document.getElementById('cardModal');
const pinModal = document.getElementById('pinModal');
const pinInput = document.getElementById('pinInput');
const pinSubmitBtn = document.getElementById('pinSubmitBtn');
const withdrawBtn = document.getElementById('withdrawBtn');
const atmUI = document.getElementById('atmUI');
const selectSound = document.getElementById('SELECTSOUND');
const mainAudio = document.getElementById('MainSound');
const withdrawStatusDiv = document.getElementById('withdrawStatus');
let current = 0, next = 1;
let isWithdrawFlow = false; // ì¶œê¸ˆ íë¦„ì¸ì§€ í”Œë˜ê·¸

/* ê´‘ê³  ìŠ¬ë¼ì´ë“œ */
function nextSlide(){
    ad2.src = ads[next];
    ad1.style.opacity = 0;
    ad2.style.opacity = 1;
    setTimeout(()=>{
        ad1.src = ads[next];
        ad1.style.opacity = 1;
        ad2.style.opacity = 0;
        current = next;
        next = (next + 1) % ads.length;
    }, 1000);
}
setInterval(nextSlide, 4000);

/* ---------------------------
   Tile í´ë¦­ ë™ì‘: t4(ì¡°íšŒ)ë§Œ imageModal. ë‚˜ë¨¸ì§€ëŠ” ì œí•œ ëª¨ë‹¬
   --------------------------- */
document.querySelectorAll('.tile').forEach(tile => {
  tile.addEventListener('click', () => {
    try { selectSound.volume = 1.0; selectSound.play().catch(()=>{}); mainAudio.volume = 0; } catch(e){}
    // ì¡°íšŒì—…ë¬´ (t4) ì²´í¬
    if (tile.classList.contains('t4')) {
      document.getElementById('imageModal').style.display = 'block';
    } else {
      document.getElementById('modal').style.display = 'block';
    }
    isWithdrawFlow = false;
  });
});

/* close modal */
document.getElementById('closeModal').addEventListener('click', ()=> {
    document.getElementById('modal').style.display='none';
    try{ selectSound.play().catch(()=>{}); }catch(e){}
});

/* start ë²„íŠ¼ */
startBtn.addEventListener('click', ()=>{
    mainAudio.volume = 1.0;
    mainAudio.play().catch(()=>{});
    document.getElementById("startScreen").style.display='none';
    document.getElementById("atmUI").style.display='block';
});

/* ---------------------------
   Web Bluetooth ì—°ê²° í•¨ìˆ˜: ì„œë¹„ìŠ¤ í•„í„° â†’ acceptAllDevices í´ë°±
   --------------------------- */
async function connectBLE() {
    if (!('bluetooth' in navigator)) throw new Error('Web Bluetooth ì§€ì› ì•ˆë¨');
    if (bleDevice && bleDevice.gatt && bleDevice.gatt.connected) return;

    // ìš°ì„  ì„œë¹„ìŠ¤ í•„í„°ë¡œ ì‹œë„
    try {
        console.log('requestDevice: service filter', NUS_SERVICE_UUID);
        const options = {
            filters: [{ services: [NUS_SERVICE_UUID] }],
            optionalServices: [NUS_SERVICE_UUID]
        };
        bleDevice = await navigator.bluetooth.requestDevice(options);
    } catch (errFilter) {
        console.warn('service filter ì‹¤íŒ¨:', errFilter);
        // í´ë°±: acceptAllDevicesë¡œ ì—´ê¸°(ì‚¬ìš©ìê°€ ì§ì ‘ ë””ë°”ì´ìŠ¤ ì„ íƒ)
        try {
            console.log('requestDevice: acceptAllDevices í´ë°±');
            const options2 = { acceptAllDevices: true, optionalServices: [NUS_SERVICE_UUID] };
            bleDevice = await navigator.bluetooth.requestDevice(options2);
        } catch (errAll) {
            console.error('acceptAllDevices ì‹¤íŒ¨:', errAll);
            throw errAll;
        }
    }

    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
    gattServer = await bleDevice.gatt.connect();
    nusService = await gattServer.getPrimaryService(NUS_SERVICE_UUID);
    txChar = await nusService.getCharacteristic(NUS_CHAR_TX_UUID);
    rxChar = await nusService.getCharacteristic(NUS_CHAR_RX_UUID);

    // notify ì‹œì‘
    await txChar.startNotifications();
    txChar.addEventListener('characteristicvaluechanged', handleNotifications);

    console.log('BLE ì—°ê²° ì™„ë£Œ:', bleDevice.name || bleDevice.id);
}

/* disconnect handler */
function onDisconnected() {
    console.warn('BLE ì¥ì¹˜ ì—°ê²° ëŠê¹€');
    showWithdrawStatus('BLE ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', true);
    // í•„ìš”í•˜ë©´ ìë™ ì¬ì—°ê²° ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
}

/* handle notifications: ëˆ„ì  + newline ê¸°ì¤€ ë¶„ë¦¬ + pending resolve */
function handleNotifications(event) {
    const value = event.target.value;
    const decoder = new TextDecoder();
    const txt = decoder.decode(value);
    console.log('notify chunk:', txt);
    notificationBuffer += txt;

    // newlineìœ¼ë¡œ ë©”ì‹œì§€ ë¶„í• 
    const parts = notificationBuffer.split(/\r?\n/);
    notificationBuffer = parts.pop() || '';

    parts.forEach(part => {
        if (!part) return;
        console.log('notify message part:', part);
        // ëª¨ë“  pending resolverì—ê²Œ ì „ë‹¬
        while (pendingResolvers.length > 0) {
            const resolver = pendingResolvers.shift();
            try { resolver(part); } catch(e){ console.error(e); }
        }
        // ì¦‰ì‹œ ì²˜ë¦¬í•  ë©”ì‹œì§€ (ì˜µì…˜)
        // if (part.includes('CARD_DETECTED')) { ... }
    });
}

/* write to device (browser -> device) */
async function writeToDevice(str) {
    if (!rxChar) throw new Error('RX characteristic ì—†ìŒ');
    const encoder = new TextEncoder();
    await rxChar.writeValue(encoder.encode(str));
}

/* readOnce: timeout ë‚´ì— CARD_DETECTEDë¥¼ ê¸°ë‹¤ë¦¼ */
function readOnce(timeoutMs = 5000) {
    return new Promise((resolve) => {
        // ë¨¼ì € ë²„í¼ì— ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
        if (notificationBuffer.includes('CARD_DETECTED')) {
            notificationBuffer = notificationBuffer.replace('CARD_DETECTED','');
            resolve(true);
            return;
        }
        let timed = false;
        const timer = setTimeout(() => {
            timed = true;
            pendingResolvers = pendingResolvers.filter(r => r !== resolver);
            resolve(false);
        }, timeoutMs);

        const resolver = (msg) => {
            if (timed) return;
            clearTimeout(timer);
            if (msg.includes('CARD_DETECTED')) {
                resolve(true);
            } else {
                resolve(false);
            }
        };
        pendingResolvers.push(resolver);
    });
}

/* startCardDetection: repeatCount íšŒ ì—°ì† ì„±ê³µ í•„ìš” */
async function startCardDetection(repeatCount = 2, timeoutPerAttempt = 5000) {
    try {
        if (!bleDevice || !bleDevice.gatt || !bleDevice.gatt.connected) {
            await connectBLE();
        }
    } catch (e) {
        console.error('BLE ì—´ê¸° ì‹¤íŒ¨', e);
        showWithdrawStatus('BLE ì—°ê²° ì‹¤íŒ¨', true, 2000);
        return false;
    }

    for (let i = 1; i <= repeatCount; i++) {
        showWithdrawStatus(`ì¹´ë“œ ê°ì§€ ì‹œì‘ ${i}íšŒì°¨`, false);
        console.log(`ì¹´ë“œ ê°ì§€ ì‹œì‘ ${i}íšŒì°¨`);
        const detected = await readOnce(timeoutPerAttempt);
        if (detected) {
            console.log(`ì¹´ë“œ ê°ì§€ ${i}íšŒì°¨ ì„±ê³µ`);
            showWithdrawStatus(`ì¹´ë“œ ì¸ì‹ ${i}íšŒì°¨ ì™„ë£Œ`, false);
            if (i < repeatCount) {
                await new Promise(r => setTimeout(r, 200));
                continue;
            }
            // ëª¨ë“  íšŒì°¨ ì„±ê³µ -> PIN ëª¨ë‹¬ë¡œ ì´ë™
            if (cardModal) cardModal.style.display = 'none';
            if (pinModal) pinModal.style.display = 'flex';
            return true;
        } else {
            console.warn(`ì¹´ë“œ ê°ì§€ ${i}íšŒì°¨ ì‹¤íŒ¨`);
            showWithdrawStatus(`ì¹´ë“œ ì¸ì‹ ${i}íšŒì°¨ ì‹¤íŒ¨`, true, 2000);
            return false;
        }
    }
    return false;
}

/* imageModal í™•ì¸ -> ì¡°íšŒ íë¦„ (ì¹´ë“œ ê°ì§€ -> PIN -> ì ê¸ˆí™”ë©´) */
document.getElementById('redirectBtn').addEventListener('click', async () => {
    document.getElementById('imageModal').style.display = 'none';
    isWithdrawFlow = false; // ì¡°íšŒ íë¦„
    cardModal.style.display = 'flex';
    showWithdrawStatus('ì¹´ë“œë¥¼ ì„¼ì„œì— ëŒ€ì„¸ìš”');
    try {
        const ok = await startCardDetection(2);
        if (!ok) {
            cardModal.style.display = 'none';
            return;
        }
        // startCardDetectionê°€ ì„±ê³µí•˜ë©´ PIN ëª¨ë‹¬ëŠ” startCardDetectionì—ì„œ ì—´ë¦¼
    } catch (e) {
        console.error(e);
        showWithdrawStatus('ì¹´ë“œ ê°ì§€ ì‹¤íŒ¨', true);
        cardModal.style.display = 'none';
    }
});

/* ì¶œê¸ˆ ë²„íŠ¼: ì¸ì¶œ íë¦„ */
withdrawBtn.addEventListener('click', () => {
    isWithdrawFlow = true;
    cardModal.style.display = 'flex';
    startCardDetection();
});

/* ì¹´ë“œ ëª¨ë‹¬ ì·¨ì†Œ */
document.getElementById('cancelCardBtn').addEventListener('click', () => {
    try { cardModal.style.display = 'none'; } catch(e){}
});

/* PIN í‚¤íŒ¨ë“œ ë¡œì§ */
const keypad = document.getElementById('keypad');
keypad.addEventListener('click', (e) => {
  if (!e.target.classList.contains('key')) return;
  const val = e.target.textContent.trim();
  if (e.target.classList.contains('clear')) {
    pinInput.value = pinInput.value.slice(0, -1);
    return;
  }
  if (val === 'í™•ì¸') {
    document.getElementById('pinSubmitBtn').click();
    return;
  }
  if (pinInput.value.length < 4) {
    pinInput.value += val;
  }
});

/* PIN ì·¨ì†Œ */
document.getElementById('pinCancelBtn').addEventListener('click', () => {
  pinModal.style.display = 'none';
});

/* PIN ì œì¶œ ì²˜ë¦¬ (ë””ì§€í„¸ í‚¤íŒ¨ë“œìš©) */
pinSubmitBtn.addEventListener('click', async () => {
  const pin = (pinInput.value || '').trim();
  if (pin.length !== 4) {
    showWithdrawStatus('PIN 4ìë¦¬ ì…ë ¥', true);
    return;
  }
  // í…ŒìŠ¤íŠ¸ìš© ê³ ì • PIN ì²´í¬ (ì‹¤ì‚¬ìš©ì‹œ ì„œë²„ ê²€ì¦ í•„ìš”)
  if (pin !== '1234') {
    showWithdrawStatus('PIN ì˜¤ë¥˜', true);
    pinInput.value = '';
    return;
  }

  // ì„±ê³µ ì²˜ë¦¬
  pinInput.value = '';
  pinModal.style.display = 'none';

  if (!isWithdrawFlow) {
    // ì¡°íšŒ íë¦„: ì ê¸ˆ ë§Œê¸° í™”ë©´
    atmUI.style.display = 'none';
    document.getElementById('depositScreen').style.display = 'block';
    createFireworks();
    createConfetti();
    showWithdrawStatus('ì¡°íšŒ ì™„ë£Œ');
    return;
  }

  // ì¸ì¶œ íë¦„: BLEë¡œ '1' ì „ì†¡
  if (isWithdrawFlow) {
    try {
      if (!rxChar) {
        showWithdrawStatus('BLE ì—°ê²° ëŠê¹€', true);
        return;
      }
      await writeToDevice('1'); // ESP32ê°€ ì´ë¥¼ ë°›ì•„ LED ë“± ë™ì‘
      showWithdrawStatus('ì¸ì¶œ ì™„ë£Œ');
      // ì¸ì¶œ ì™„ë£Œ í™”ë©´
      atmUI.style.display = 'none';
      document.getElementById('depositScreen').style.display = 'block';
      createFireworks();
      createConfetti();
    } catch (e) {
      console.error('ì¸ì¶œ ì‹ í˜¸ ì „ì†¡ ì‹¤íŒ¨', e);
      showWithdrawStatus('ì¸ì¶œ ì‹ í˜¸ ì‹¤íŒ¨', true);
    }
    isWithdrawFlow = false;
  }
});

/* MutationObserver: cardModalì´ ì—´ë¦¬ë©´ ì¹´ë“œ ê°ì§€ ì‹œì‘ (ë³´ì¡°) */
const observer = new MutationObserver(() => {
    const display = window.getComputedStyle(cardModal).display;
    if (display !== 'none') {
        // cardModalì´ ë³´ì´ë©´ ê°ì§€ ì‹œì‘(ì´ë¯¸ startCardDetection í˜¸ì¶œí•œ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ê°€ëŠ¥, ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
        // startCardDetection();
    }
});
observer.observe(cardModal, { attributes: true });

/* ìƒíƒœ í‘œì‹œ */
function showWithdrawStatus(msg, isError=false, duration=2000){
    withdrawStatusDiv.textContent = msg;
    withdrawStatusDiv.style.background = isError ? "rgba(255,64,129,0.95)" : "rgba(0,120,255,0.95)";
    withdrawStatusDiv.style.display = "block";
    setTimeout(()=>{ withdrawStatusDiv.style.display = "none"; }, duration);
}

/* í­ì£½/ì½˜í˜í‹° */
function createFireworks(){
    for(let i=0;i<200;i++){
        const dot=document.createElement('div');
        dot.className='firework';
        dot.style.left=(window.innerWidth/2+(Math.random()-0.5)*200)+'px';
        dot.style.top=(window.innerHeight/2+(Math.random()-0.5)*200)+'px';
        const angle=Math.random()*2*Math.PI;
        const dist=600+Math.random()*100;
        dot.style.setProperty('--x',`${Math.cos(angle)*dist}px`);
        dot.style.setProperty('--y',`${Math.sin(angle)*dist}px`);
        dot.style.background=`hsl(${Math.random()*360},80%,60%)`;
        document.body.appendChild(dot);
        setTimeout(()=>dot.remove(),1000);
    }
}
function createConfetti(){
    for(let i=0;i<400;i++){
        const c=document.createElement('div');
        c.className='confetti';
        c.style.left=Math.random()*window.innerWidth+'px';
        c.style.top=Math.random()*window.innerHeight+'px';
        c.style.width=c.style.height=(5+Math.random()*10)+'px';
        c.style.background=`hsl(${Math.random()*360},70%,60%)`;
        c.style.animationDuration=(2+Math.random()*3)+'s';
        document.body.appendChild(c);
        setTimeout(()=>c.remove(), 7000);
    }
}

/* withdraw button scroll behavior */
window.addEventListener('scroll', ()=>{
    const scrollTop = window.scrollY,
          scrollHeight = document.body.scrollHeight - window.innerHeight;
    withdrawBtn.style.bottom = (scrollTop >= scrollHeight - 50) ? '20px' : '-80px';
});

/* ì „ì²´í™”ë©´ ë²„íŠ¼: BLE ì—°ê²° ì‹œë„ + ì „ì²´í™”ë©´ */
fullscreenBtn.addEventListener('click', async () => {
    fullscreenBtn.style.display = 'none';
    try {
        await connectBLE();
        alert('BLE ì—°ê²° ì„±ê³µ!');
    } catch (e) {
        console.error('BLE ì—°ê²° ì‹¤íŒ¨:', e);
        alert('BLE ì—°ê²° ì‹¤íŒ¨: ' + (e && e.message ? e.message : e));
        fullscreenBtn.style.display = '';
    }
    // ì „ì²´í™”ë©´
    const elem = document.documentElement;
    try {
      if (elem.requestFullscreen) await elem.requestFullscreen();
      else if (elem.webkitRequestFullscreen) await elem.webkitRequestFullscreen();
      else if (elem.msRequestFullscreen) await elem.msRequestFullscreen();
    } catch(e){}
});

/* ë””ë²„ê·¸ ìœ í‹¸: ì½˜ì†”ì— ë²„í¼ ìƒíƒœ ë³´ê¸° ê°€ëŠ¥ */
window.debugShowBuffer = function(){ console.log('notificationBuffer:', JSON.stringify(notificationBuffer), 'pendingResolvers:', pendingResolvers.length); };
</script>
</body>
</html>
